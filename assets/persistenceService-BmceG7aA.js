import{s as a}from"./index-D2MuJ3dS.js";import"./react-vendor-CxjHvgps.js";import"./pdf-vendor-DpgYL85d.js";import"./ai-vendor-BpRkNtKl.js";import"./doc-vendor-DE1ncqha.js";class n{constructor(){this.queue=[],this.listeners=[],this.status="idle",this.processing=!1,this.loadQueue()}loadQueue(){try{if(typeof window>"u")return;const s=localStorage.getItem("tutesis_save_queue");s&&(this.queue=JSON.parse(s),this.queue.length>0&&(this.status="saving",this.processQueue()))}catch(s){console.error("[Persistence] Failed to load queue",s)}}saveQueueToLocal(){typeof window>"u"||localStorage.setItem("tutesis_save_queue",JSON.stringify(this.queue))}notify(s){this.status=s,this.listeners.forEach(e=>e(s))}subscribe(s){return this.listeners.push(s),s(this.status),()=>{this.listeners=this.listeners.filter(e=>e!==s)}}async saveAnalysis(s,e,t){const i={id:crypto.randomUUID(),projectId:s,type:e,result:t,attempts:0,timestamp:Date.now()};this.queue.push(i),this.saveQueueToLocal(),this.notify("saving"),this.processQueue()}async processQueue(){if(this.processing||this.queue.length===0)return;this.processing=!0;const s=3;try{const e=this.queue[0];let t="ok",i=[];if(e.type==="consistency"){const r=e.result;t=r.analysisStatus||"ok",i=r.analysisWarnings||[]}const{error:o}=await a.from("analysis_reports").insert({project_id:e.projectId,type:e.type,result:e.result,status:t,warnings:i,version:"1.0"});o?(console.warn("[Persistence] Save failed (retry pending):",o.message),e.attempts++,e.attempts>=s?(console.error("[Persistence] Max retries reached. Dropping item:",e.id),this.queue.shift()):await new Promise(r=>setTimeout(r,1e3*e.attempts))):this.queue.shift(),this.saveQueueToLocal(),this.queue.length>0?(this.processing=!1,this.processQueue()):(this.processing=!1,this.notify("saved"),setTimeout(()=>this.notify("idle"),3e3))}catch(e){console.error("[Persistence] Critical Queue Error:",e),this.processing=!1,this.notify("error")}}async getLatestAnalysis(s,e){const{data:t,error:i}=await a.from("analysis_reports").select("*").eq("project_id",s).eq("type",e).order("created_at",{ascending:!1}).limit(1).single();return i?null:t}}const d=new n;export{d as persistenceService};
